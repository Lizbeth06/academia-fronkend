<div class="convocatoria-container">
  <!-- Header Compacto -->
  <div class="header-section">
    <h1 class="titulo-principal">CONVOCATORIAS ABIERTAS</h1>
    <p class="subtitulo">Encuentra oportunidades para formar parte de nuestra comunidad deportiva</p>
  </div>

  <div *ngIf="!modoGestion">
    <!-- Barra de búsqueda y filtros -->
    <div class="search-filter-section">
      <!-- Buscador principal -->
      <div class="search-container">
        <mat-form-field appearance="outline" class="search-field">
          <mat-label>Buscar convocatorias</mat-label>
          <input matInput [(ngModel)]="busqueda" (ngModelChange)="aplicarFiltros()" placeholder="Título, organización, descripción..." />
          <mat-icon matPrefix>search</mat-icon>
          @if (busqueda) {
          <button mat-icon-button matSuffix (click)="busqueda = ''; aplicarFiltros()">
            <mat-icon>close</mat-icon>
          </button>
          }
        </mat-form-field>
        <!-- Botón toggle filtros -->
        <button mat-raised-button color="primary" class="btn-filtros" (click)="toggleFiltros()">
          <mat-icon>filter_list</mat-icon>
          {{ mostrarFiltros ? "Ocultar Filtros" : "Mostrar Filtros" }}
        </button>
      </div>
      <!-- Panel de filtros ACTUALIZADO -->
      <div class="filtros-panel" [class.expanded]="mostrarFiltros">
        <div class="filtros-grid">
          <!-- Filtro Región -->
          <mat-form-field appearance="outline">
            <mat-label>Región</mat-label>
            <mat-select [(ngModel)]="regionSeleccionada" (ngModelChange)="aplicarFiltros()">
              <mat-option value="">Todas las regiones</mat-option>
              @for (region of regiones; track region) {
              <mat-option [value]="region">
                {{ region }}
              </mat-option>
              }
            </mat-select>
            <mat-icon matPrefix>location_on</mat-icon>
          </mat-form-field>
          <!-- Filtro Sede -->
          <mat-form-field appearance="outline">
            <mat-label>Sede</mat-label>
            <mat-select [(ngModel)]="sedeSeleccionada" (ngModelChange)="aplicarFiltros()">
              <mat-option value="">Todas las sedes</mat-option>
              @for (sede of sedes; track sede) {
              <mat-option [value]="sede">
                {{ sede }}
              </mat-option>
              }
            </mat-select>
            <mat-icon matPrefix>stadium</mat-icon>
          </mat-form-field>
          <!-- Filtro Deporte (NUEVO) -->
          <mat-form-field appearance="outline">
            <mat-label>Deporte</mat-label>
            <mat-select [(ngModel)]="deporteSeleccionado" (ngModelChange)="aplicarFiltros()">
              <mat-option value="">Todos los deportes</mat-option>
              @for (deporte of deportes; track deporte) {
              <mat-option [value]="deporte">
                {{ deporte }}
              </mat-option>
              }
            </mat-select>
            <mat-icon matPrefix>sports_soccer</mat-icon>
          </mat-form-field>
          <!-- Filtro Tipo Convocatoria (NUEVO) -->
          <mat-form-field appearance="outline">
            <mat-label>Tipo Convocatoria</mat-label>
            <mat-select [(ngModel)]="tipoSeleccionado" (ngModelChange)="aplicarFiltros()">
              <mat-option value="">Todos los tipos</mat-option>
              @for (tipo of tiposConvocatoria; track tipo) {
              <mat-option [value]="tipo.idTipoconvocatoria">
                {{ tipo.descripcion }}
              </mat-option>
              }
            </mat-select>
            <mat-icon matPrefix>category</mat-icon>
          </mat-form-field>
          <!-- Botón limpiar -->
          <button mat-raised-button class="btn-limpiar" (click)="limpiarFiltros()">
            <mat-icon>clear_all</mat-icon>
            Limpiar Filtros
          </button>
        </div>
      </div>
      <!-- Resultados y Gestionar -->
      <div class="resultados-row">
        <button mat-raised-button color="primary" class="btn-gestionar" (click)="toggleModoGestion()">
          <mat-icon>settings</mat-icon>
          Gestionar Convocatorias
        </button>
      </div>
    </div>
    <!-- Loader -->
    @if (cargando) {
    <div class="loader-container">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Cargando convocatorias...</p>
    </div>
    }

    <div class="convocatorias-home-grid" *ngIf="listaconvocatoriaCard.length > 0">
      <mat-card class="convocatoria-card-home" *ngFor="let conv of listaconvocatoriaCard">
        <div class="card-image-container">
          <img
            mat-card-image
            [src]="conv.convocatoria.urlImagen === null ? 'assets/images/placeholder-convocatoria.jpg' : conv.convocatoria.urlImagen"
            alt="imagen convocatoria"
          />

          <div class="estado-badge" [ngClass]="conv.horario.modalidad.idModalidad === 2 ? 'tipo-paradeporte' : 'tipo-deporte'">
            <mat-icon class="estado-icon">
              {{ conv.convocatoria.estado === "1" ? "check_circle" : "cancel" }}
            </mat-icon>
            {{ conv.horario.modalidad.descripcion }}
          </div>

          <!--<div class="tipo-badge" [ngClass]="getTipoClass(conv.tipo)">
            {{ getTipoTexto(conv.tipo) }}
          </div>
          <div class="card-overlay">
            <button mat-mini-fab color="primary" (click)="verPreview(conv)" matTooltip="Ver detalles">
              <mat-icon>visibility</mat-icon>
            </button>
            <button mat-mini-fab color="accent" (click)="compartir(conv)" matTooltip="Compartir">
              <mat-icon>share</mat-icon>
            </button>
          </div> -->
        </div>
        <mat-card-content>
          <h3 class="card-title">{{ conv.convocatoria.titulo }}</h3>
          <p class="card-organizacion">
            <mat-icon class="org-icon">business</mat-icon>
            {{ conv.convocatoria.subtitulo }}
          </p>
        </mat-card-content>
        <!--<div class="cupos-container-compact">
            <div class="cupos-header">
              <span class="cupos-label">Cupos disponibles</span>
              <span class="cupos-number">
                <strong>{{ conv.numdisponibles }}</strong> / {{ conv.numvacantes }}
              </span>
            </div>
            <div class="progress-bar">
              <div
                class="progress-fill"
                [style.width.%]="getPorcentajeCupos(conv)"
                [ngClass]="{
                  'progress-low': getPorcentajeCupos(conv) < 50,
                  'progress-medium': getPorcentajeCupos(conv) >= 50 && getPorcentajeCupos(conv) < 80,
                  'progress-high': getPorcentajeCupos(conv) >= 80
                }"
              ></div>
            </div>
          </div>
          <button
            mat-raised-button
            color="primary"
            class="btn-inscribir"
            (click)="inscribirse(conv)"
            [disabled]="conv.estado !== 'activa' || conv.numdisponibles === 0"
          >
            <mat-icon>how_to_reg</mat-icon>
            {{ conv.estado === "activa" && conv.numdisponibles > 0 ? "Inscribirse Ahora" : "No disponible" }}
          </button>
        </mat-card-content> -->
      </mat-card>
    </div>

    <div class="no-results">
      <mat-icon>search_off</mat-icon>
      <h3>No se encontraron convocatorias</h3>
      <p>Intenta ajustar los filtros de búsqueda</p>
      <button mat-raised-button color="primary" (click)="limpiarFiltros()">Limpiar filtros</button>
    </div>
  </div>

  <!-- ========================================== -->
  <!-- MODO GESTIÓN -->
  <!-- ========================================== -->
  @if (modoGestion) {
  <div class="gestion-container">
    <div class="gestion-header">
      <h2>Gestión de Convocatorias</h2>
      <div class="gestion-buttons">
        <button mat-raised-button color="accent" (click)="toggleModoGestion()">
          <mat-icon>visibility</mat-icon>
          Ver Convocatorias
        </button>
        <button mat-raised-button color="primary" routerLink="agregar">
          <mat-icon>add</mat-icon>
          Nueva Convocatoria
        </button>
      </div>
    </div>
    <div class="tabla-gestion">
      <table mat-table [dataSource]="listaCovocatoria" class="mat-elevation-z2">
        <ng-container matColumnDef="numero">
          <th mat-header-cell *matHeaderCellDef>N°</th>
          <td mat-cell *matCellDef="let conv; let i = index">{{ i + 1 }}</td>
        </ng-container>
        <ng-container matColumnDef="titulo">
          <th mat-header-cell *matHeaderCellDef>Título</th>
          <td mat-cell *matCellDef="let conv">{{ conv.convocatoria.titulo }}</td>
        </ng-container>
        <ng-container matColumnDef="subtitulo">
          <th mat-header-cell *matHeaderCellDef>Subtítulo</th>
          <td mat-cell *matCellDef="let conv">{{ conv.convocatoria.subtitulo }}</td>
        </ng-container>
        <ng-container matColumnDef="region">
          <th mat-header-cell *matHeaderCellDef>Región</th>
          <td mat-cell *matCellDef="let conv">{{ conv.horario.listadisciplina.sede.ubicacion.split("/")[0] }}</td>
        </ng-container>
        <ng-container matColumnDef="sede">
          <th mat-header-cell *matHeaderCellDef>Sede</th>
          <td mat-cell *matCellDef="let conv">{{ conv.horario.listadisciplina.sede.nombre }}</td>
        </ng-container>
        <ng-container matColumnDef="deporte">
          <th mat-header-cell *matHeaderCellDef>Deporte</th>
          <td mat-cell *matCellDef="let conv">{{ conv.horario.listadisciplina.disciplina.descripcion }}</td>
        </ng-container>
        <ng-container matColumnDef="numdisponibles">
          <th mat-header-cell *matHeaderCellDef>Disponibles</th>
          <td mat-cell *matCellDef="let conv">{{ conv.horario.numVacante - conv.horario.contador }}/{{ conv.horario.numVacante }}</td>
        </ng-container>
        <ng-container matColumnDef="estado">
          <th mat-header-cell *matHeaderCellDef>Estado</th>
          <td mat-cell *matCellDef="let conv">
            <span class="badge-estado">
              {{ conv.estado === "1" ? "EN CURSO" : "CERRADO" }}
            </span>
          </td>
        </ng-container>
        <ng-container matColumnDef="acciones">
          <th mat-header-cell *matHeaderCellDef>Acciones</th>
          <td mat-cell *matCellDef="let conv">
            <button mat-icon-button matTooltip="Ver preview" (click)="verPreview(conv)">
              <mat-icon>visibility</mat-icon>
            </button>
            <button mat-icon-button color="primary" matTooltip="Editar" (click)="editarConvocatoria(conv)">
              <mat-icon>edit</mat-icon>
            </button>
            <!-- <button mat-icon-button color="warn" matTooltip="Eliminar" (click)="eliminarConvocatoria(conv)">
              <mat-icon>delete</mat-icon>
            </button> -->
          </td>
        </ng-container>
        <tr mat-header-row *matHeaderRowDef="columnasTabla"></tr>
        <tr mat-row *matRowDef="let row; columns: columnasTabla"></tr>

        <tr class="mat-row" *matNoDataRow>
          <td class="mat-cell text-center" colspan="9">No existe convocatorias que mostrar</td>
        </tr>
      </table>
    </div>
    <mat-paginator [pageSizeOptions]="[5, 10, 25, 100]" aria-label="Select page of users" showFirstLastButtons></mat-paginator>
  </div>
  }

  <!-- ========================================== -->
  <!-- MODAL FORMULARIO CON UPLOAD DE IMAGEN -->
  <!-- ========================================== -->
  @if (mostrarFormulario) {
  <div class="modal-overlay-fullscreen" (click)="cerrarFormulario()">
    <div class="modal-formulario" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ modoEdicion ? "Editar Convocatoria" : "Nueva Convocatoria" }}</h2>
        <button mat-icon-button (click)="cerrarFormulario()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <div class="modal-body">
        <form class="formulario-convocatoria">
          <!-- Título -->
          <mat-form-field appearance="outline" class="field-full">
            <mat-label>Título *</mat-label>
            <input matInput [(ngModel)]="nuevaConvocatoria.titulo" name="titulo" required />
            @if (erroresFormulario['titulo']) {
            <mat-error>El título es obligatorio</mat-error>
            }
          </mat-form-field>
          <!-- Subtítulo -->
          <mat-form-field appearance="outline" class="field-full">
            <mat-label>Subtítulo *</mat-label>
            <input matInput [(ngModel)]="nuevaConvocatoria.subtitulo" name="subtitulo" required />
            @if (erroresFormulario['subtitulo']) {
            <mat-error>El subtítulo es obligatorio</mat-error>
            }
          </mat-form-field>
          <!-- Descripción -->
          <mat-form-field appearance="outline" class="field-full">
            <mat-label>Descripción *</mat-label>
            <textarea matInput [(ngModel)]="nuevaConvocatoria.descripcion" name="descripcion" rows="3" required></textarea>
            @if (erroresFormulario['descripcion']) {
            <mat-error>La descripción es obligatoria</mat-error>
            }
          </mat-form-field>
          <!-- Upload de Imagen -->
          <div class="upload-container">
            <label class="upload-label">Imagen de la Convocatoria</label>
            <input type="file" id="fileUpload" accept="image/*" (change)="onImagenSeleccionada($event)" hidden #fileInput />
            <button mat-raised-button type="button" color="primary" (click)="fileInput.click()" class="btn-upload">
              <mat-icon>cloud_upload</mat-icon>
              {{ imagenPreview ? "Cambiar Imagen" : "Seleccionar Imagen" }}
            </button>
            <!-- Preview de imagen -->
            @if (imagenPreview) {
            <div class="imagen-preview">
              <img [src]="imagenPreview" alt="Preview" />
              <!-- <button
                mat-icon-button
                class="btn-eliminar-imagen"
                (click)="imagenPreview = ''; imagenSeleccionada = null; nuevaConvocatoria.urlimagen = ''"
                matTooltip="Eliminar imagen"
              >
                <mat-icon>close</mat-icon>
              </button> -->
            </div>
            }
          </div>
          <!-- Cupos -->
          <div class="seccion-titulo">Cupos</div>
          <div class="form-row">
            <mat-form-field appearance="outline" class="field-half">
              <mat-label>Vacantes *</mat-label>
              <!-- <input matInput type="number" [(ngModel)]="nuevaConvocatoria.numvacantes" name="numvacantes" min="1" required /> -->
              @if (erroresFormulario['numvacantes']) {
              <mat-error>Debe ser mayor a 0</mat-error>
              }
            </mat-form-field>
            <!-- <mat-form-field appearance="outline" class="field-half">
              <mat-label>Disponibles *</mat-label>
              <input matInput type="number" [(ngModel)]="nuevaConvocatoria.numdisponibles" name="numdisponibles" min="0" required />
              @if (erroresFormulario['numdisponibles']) {
              <mat-error>No puede ser negativo</mat-error>
              }
            </mat-form-field> -->
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button mat-raised-button (click)="cerrarFormulario()">Cancelar</button>
        <button mat-raised-button color="primary" (click)="guardarConvocatoria()">
          {{ modoEdicion ? "Actualizar" : "Guardar" }}
        </button>
      </div>
    </div>
  </div>
  }

  <!-- ========================================== -->
  <!-- MODAL PREVIEW -->
  <!-- ========================================== -->
  @if (mostrarPreview) {
  <div class="modal-overlay-fullscreen" (click)="cerrarPreview()">
    <div class="modal-preview" (click)="$event.stopPropagation()">
      <button class="btn-cerrar-preview" (click)="cerrarPreview()">
        <mat-icon>close</mat-icon>
      </button>
      <h2 class="preview-titulo">Vista Previa</h2>
      @if (convocatoriaPreview) {
      <!-- <mat-card class="convocatoria-card-home">
        <div class="card-image-container">
          <img mat-card-image [src]="convocatoriaPreview.urlimagen" [alt]="convocatoriaPreview.titulo" />
          <div class="estado-badge" [ngClass]="getEstadoClass(convocatoriaPreview.estado)">
            <mat-icon class="estado-icon">
              {{ convocatoriaPreview.estado === "activa" ? "check_circle" : "cancel" }}
            </mat-icon>
            {{ getEstadoTexto(convocatoriaPreview.estado) }}
          </div>
          <div class="tipo-badge" [ngClass]="getTipoClass(convocatoriaPreview.tipo)">
            {{ getTipoTexto(convocatoriaPreview.tipo) }}
          </div>
        </div>
        <mat-card-content>
          <h3 class="card-title">{{ convocatoriaPreview.titulo }}</h3>
          <p class="card-organizacion">
            <mat-icon class="org-icon">business</mat-icon>
            {{ convocatoriaPreview.subtitulo }}
          </p>
          <div class="card-info-compact">
            <div class="info-chip">
              <mat-icon>place</mat-icon>
              <span>{{ convocatoriaPreview.sede }}</span>
            </div>
            <div class="info-chip">
              <mat-icon>sports_soccer</mat-icon>
              <span>{{ convocatoriaPreview.deporte }}</span>
            </div>
            @if (convocatoriaPreview.frecuencia) {
            <div class="info-chip">
              <mat-icon>schedule</mat-icon>
              <span>{{ convocatoriaPreview.frecuencia }}</span>
            </div>
            }
          </div>
          <div class="cupos-container-compact">
            <div class="cupos-header">
              <span class="cupos-label">Cupos disponibles</span>
              <span class="cupos-number">
                <strong>{{ convocatoriaPreview.numdisponibles }}</strong> / {{ convocatoriaPreview.numvacantes }}
              </span>
            </div>
            <div class="progress-bar">
              <div
                class="progress-fill"
                [style.width.%]="getPorcentajeCupos(convocatoriaPreview)"
                [ngClass]="{
                  'progress-low': getPorcentajeCupos(convocatoriaPreview) < 50,
                  'progress-medium': getPorcentajeCupos(convocatoriaPreview) >= 50 && getPorcentajeCupos(convocatoriaPreview) < 80,
                  'progress-high': getPorcentajeCupos(convocatoriaPreview) >= 80
                }"
              ></div>
            </div>
          </div>
        </mat-card-content>
      </mat-card> -->
      }
    </div>
  </div>
  }

  <!-- ========================================== -->
  <!-- MODAL CONFIRMACIÓN PERSONALIZADO -->
  <!-- ========================================== -->
  @if (mostrarConfirmacion) {
  <div class="modal-overlay-fullscreen">
    <div class="modal-confirmacion">
      <div class="confirmacion-header">
        <mat-icon class="icono-confirmacion">help_outline</mat-icon>
        <h2>{{ tituloConfirmacion }}</h2>
      </div>
      <div class="confirmacion-body">
        <p>{{ mensajeConfirmacion }}</p>
      </div>
      <div class="confirmacion-footer">
        <button mat-raised-button (click)="cancelarConfirmacion()">Cancelar</button>
        <button mat-raised-button color="warn" (click)="confirmarAccion()">Confirmar</button>
      </div>
    </div>
  </div>
  }

  <!-- ========================================== -->
  <!-- MENSAJE CENTRAL (Success/Error/Loading) -->
  <!-- ========================================== -->
  @if (mostrarMensajeCentral) {
  <div class="mensaje-central-overlay">
    <div class="mensaje-central" [ngClass]="'mensaje-' + tipoMensaje">
      @if (tipoMensaje === 'loading') {
      <mat-spinner diameter="40" class="spinner-central"></mat-spinner>
      } @if (tipoMensaje === 'success') {
      <mat-icon class="icono-central">check_circle</mat-icon>
      } @if (tipoMensaje === 'error') {
      <mat-icon class="icono-central">error</mat-icon>
      }
      <p class="texto-central">{{ textoMensaje }}</p>
    </div>
  </div>
  }
</div>
