<mat-tab-group animationDuration="200ms" class="px-2" [(selectedIndex)]="tabIndex">
  <mat-tab label="Convocatoria" class="tab-content">
    <div class="seccion-superior pb-1">
      <h3 class="fs-6 fw-400 mb-4 pl-4" align="start">Selección de horarios creados por sede deportivo</h3>
      <app-selecthorario-form (horariosSeleccionados)="horariosAgregados($event)" />
    </div>
    <div class="seccion-inferior">
      <h3 class="fs-6 fw-400 mb-4 pl-4" align="start">Información de convocatorias</h3>
      <form [formGroup]="convocatoriaForm" (ngSubmit)="crearConvocatoria()" class="row m-2">
        <div class="col-12 col-md-3">
          <mat-form-field appearance="outline" class="full-width mat-body">
            <mat-label class="mat-body">Título</mat-label>
            <input matInput formControlName="titulo" placeholder="Ingrese título" />
            <mat-error><ng-container *ngIf="convocatoriaForm.get('titulo')?.hasError('required')">Campo obligatorio</ng-container></mat-error>
          </mat-form-field>
        </div>
        <div class="col-12 col-md-3">
          <mat-form-field appearance="outline" class="full-width mat-body">
            <mat-label class="mat-body">Subtítulo</mat-label>
            <input matInput formControlName="subtitulo" placeholder="Ingrese un subtítulo" />
            <mat-error><ng-container *ngIf="convocatoriaForm.get('subtitulo')?.hasError('required')">Campo obligatorio</ng-container></mat-error>
          </mat-form-field>
        </div>

        <div class="col-12 col-md-3">
          <mat-form-field appearance="outline" class="full-width mat-body">
            <mat-label class="mat-body">Temporada</mat-label>
            <mat-select formControlName="temporada" placeholder="Seleccione temporada" (selectionChange)="onSelecciontemporada()">
              <mat-option *ngFor="let temp of temporada" [value]="temp">{{ temp.descripcion }}</mat-option>
            </mat-select>
            <mat-error><ng-container *ngIf="convocatoriaForm.get('temporada')?.hasError('required')">Campo obligatorio</ng-container></mat-error>
          </mat-form-field>
        </div>

        <div class="col-12 col-md-3">
          <mat-form-field appearance="outline" class="full-width mat-body">
            <mat-label class="mat-body">Estado</mat-label>
            <mat-select formControlName="estado" placeholder="Seleccione estado">
              <mat-option [value]="1">EN CURSO</mat-option>
              <mat-option [value]="0">CERRADO</mat-option>
            </mat-select>
            <mat-error><ng-container *ngIf="convocatoriaForm.get('estado')?.hasError('required')">Campo obligatorio</ng-container></mat-error>
          </mat-form-field>
        </div>

        <div class="col-12 col-sm-6 col-md-3">
          <mat-form-field appearance="outline">
            <mat-label>Fecha inicio de clase</mat-label>
            <input matInput formControlName="finicioclase" />
            <mat-error *ngIf="convocatoriaForm.get('finicioclase')?.hasError('required')"> Campo obligatorio </mat-error>
          </mat-form-field>
        </div>
        <div class="col-12 col-sm-6 col-md-3">
          <mat-form-field appearance="outline">
            <mat-label>Fecha fin de clase</mat-label>
            <input matInput formControlName="fcierreclase" />
          </mat-form-field>
        </div>
        <div class="col-12 col-sm-6 col-md-3">
          <mat-form-field appearance="outline">
            <mat-label>Fecha inicio inscripción</mat-label>
            <input matInput formControlName="finicioinscripcion" />
          </mat-form-field>
        </div>
        <div class="col-12 col-sm-6 col-md-3">
          <mat-form-field appearance="outline">
            <mat-label>Fecha cierre de inscripción</mat-label>
            <input matInput formControlName="fcierreinscripcion" />
          </mat-form-field>
        </div>
        <div class="col-12 col-md-12">
          <mat-form-field appearance="outline" class="full-width mat-body">
            <mat-label class="mat-body">Descripción</mat-label>
            <textarea matInput formControlName="descripcion" rows="1" placeholder="Ingrese una descripción"></textarea>
            <mat-error><ng-container *ngIf="convocatoriaForm.get('descripcion')?.hasError('required')">Campo obligatorio</ng-container></mat-error>
          </mat-form-field>
        </div>
        <div class="col-12 col-md-12 mb-4" *ngIf="habilitar">
          <h3 class="fs-6 text-center my-2">Lista de horarios a seleccionar</h3>
          <div class="mb-2" align="end">
            <button matButton="elevated" [matBadge]="numeroHorarios"><mat-icon>list_alt</mat-icon>Ver</button>
          </div>
          <table mat-table [dataSource]="dataHorario" class="mat-elevation-z8">
            <!-- Checkbox Column -->
            <ng-container matColumnDef="select">
              <th mat-header-cell *matHeaderCellDef>
                <mat-checkbox
                  (change)="$event ? seleccionarTodas() : null"
                  [checked]="selection.hasValue() && compararSeleccion()"
                  [indeterminate]="selection.hasValue() && !compararSeleccion()"
                  [aria-label]="marcarCasilla()"
                >
                </mat-checkbox>
              </th>
              <td mat-cell *matCellDef="let row">
                <mat-checkbox
                  (click)="$event.stopPropagation()"
                  (change)="onCheckboxChange($event, row)"
                  [checked]="selection.isSelected(row)"
                  [aria-label]="marcarCasilla(row)"
                >
                </mat-checkbox>
              </td>
            </ng-container>

            <ng-container matColumnDef="horario">
              <th mat-header-cell *matHeaderCellDef>Horarios por sede</th>
              <td mat-cell *matCellDef="let row">{{ resumenHorario(row) }}</td>
            </ng-container>

            <!-- Name Column -->
            <ng-container matColumnDef="modalidad">
              <th mat-header-cell *matHeaderCellDef>Modalidad</th>
              <td mat-cell *matCellDef="let row">{{ row.modalidad.descripcion }}</td>
            </ng-container>

            <!-- Weight Column -->
            <ng-container matColumnDef="ubicacion">
              <th mat-header-cell *matHeaderCellDef>Ubicación sede</th>
              <td mat-cell *matCellDef="let row">{{ row.listadisciplina.sede.ubicacion }}</td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns" (click)="selection.toggle(row)"></tr>

            <tr class="mat-row" *matNoDataRow>
              <td class="mat-cell text-center" colspan="4">No existe horarios que mostrar</td>
            </tr>
          </table>
        </div>

        <div class="col-12 col-md-12 capa-image">
          <div class="image-container" matTooltip="Subir imagen" matTooltipPosition="above">
            <input class="image-input" type="file" (change)="onImage($event)" #image accept="image/jpeg, image/png" name="image logo" />
            <mat-icon (click)="!habilitar || image.click()" *ngIf="!selectedImage" style="cursor: pointer">add_a_photo</mat-icon>
            <div class="d-flex flex-column gap-2" *ngIf="selectedImage">
              <div class="loader d-flex" *ngIf="loading"></div>
              <img
                (load)="loading = false"
                [src]="selectedImage"
                alt="Image convocatoria"
                style="max-width: 100%; max-height: 700px; margin-top: 8px"
              />
              <button mat-button color="warn" (click)="removeImage()">Quitar imagen</button>
            </div>
          </div>
        </div>
      </form>
      <div class="mt-4 text-center">
        <button
          matButton="filled"
          color="warn"
          (click)="cargarImage()"
          type="submit"
          [disabled]="convocatoriaForm.invalid || selection.selected.length === 0 || desabilitar"
        >
          <div class="loader d-flex" *ngIf="desabilitar"></div>
          <mat-icon>save</mat-icon>Publicar
        </button>
      </div>
    </div>

    <div class="mt-4" align="end">
      <button matButton="outlined" color="warn" class="mr-3" (click)="nextTab('horario')">
        <mat-icon>subdirectory_arrow_right</mat-icon>Ir a agregar horarios
      </button>
    </div>
  </mat-tab>

  <!-- Disciplinas y sede -->

  <mat-tab label="Agregar horarios por sede">
    <form [formGroup]="complejoForm" class="row mt-4">
      <div class="col-12 col-md-3">
        <mat-form-field appearance="outline">
          <mat-label>Departamento</mat-label>
          <mat-select formControlName="departamento" placeholder="Departamentos" (selectionChange)="onDepartamentoChange()">
            <mat-option *ngFor="let dep of departamentos" [value]="dep">{{ dep.ubiNombre }}</mat-option>
          </mat-select>
          <mat-error *ngIf="complejoForm.get('departamento')?.hasError('required')">Campo obligatorio </mat-error>
        </mat-form-field>
      </div>
      <div class="col-12 col-md-3">
        <mat-form-field appearance="outline">
          <mat-label>Provincia</mat-label>
          <mat-select formControlName="provincia" placeholder="Provincias" (selectionChange)="onProvinciaChange()">
            <mat-option *ngFor="let prov of provincias" [value]="prov">{{ prov.ubiNombre }}</mat-option>
          </mat-select>
          <mat-error *ngIf="complejoForm.get('provincia')?.hasError('required')">Campo obligatorio </mat-error>
        </mat-form-field>
      </div>

      <div class="col-12 col-md-3">
        <mat-form-field appearance="outline">
          <mat-label>Distrito</mat-label>
          <mat-select formControlName="distrito" placeholder="Distritos" (selectionChange)="onDistritoChange()">
            <mat-option *ngFor="let dist of distritos" [value]="dist">{{ dist.ubiNombre }}</mat-option>
          </mat-select>
          <mat-error *ngIf="complejoForm.get('distrito')?.hasError('required')">Campo obligatorio </mat-error>
        </mat-form-field>
      </div>

      <div class="col-12 col-md-3">
        <mat-form-field appearance="outline">
          <mat-label>Complejo</mat-label>
          <mat-select formControlName="sede" placeholder="Sedes" (selectionChange)="actualizarTablaHorario()">
            <mat-option *ngFor="let s of sedes" [value]="s.idSede">{{ s.nombre }}</mat-option>
          </mat-select>
          <mat-error *ngIf="complejoForm.get('sede')?.hasError('required')">Campo obligatorio</mat-error>
        </mat-form-field>
      </div>
    </form>
    <div class="row" style="padding: 0 12px">
      <div class="col-12 col-md-12 seccion-top" align="center">
        <form [formGroup]="disciplinaForm">
          <mat-form-field appearance="outline">
            <mat-label>Disciplina</mat-label>
            <mat-select formControlName="nombre">
              <mat-option>Seleccione disciplina</mat-option>
              <mat-option *ngFor="let dis of disciplina" [value]="dis">{{ dis.descripcion }}</mat-option>
            </mat-select>
            <mat-error *ngIf="disciplinaForm.get('nombre')?.hasError('required')"> Campo obligatorio </mat-error>
          </mat-form-field>
        </form>
        <p class="mx-4 my-0">¿Está seguro que desea agregar esta disciplina?</p>
        <button
          mat-flat-button
          color="primary"
          class="loadButton"
          type="button"
          (click)="addDisciplina()"
          [disabled]="disciplinaForm.invalid || complejoForm.invalid"
        >
          <mat-icon>save</mat-icon>Agregar
        </button>
      </div>
      <div class="col-12 col-md-12 seccion-bottom">
        <p *ngIf="listaDisciplinas.length === 0" class="card-subtitle text-center p-4">No existe horarios asignados</p>
        <div class="loader d-flex" *ngIf="loading"></div>
        <div *ngFor="let disciplina of listaDisciplinas; let idx = index" class="card-disciplinas my-3">
          <h3 class="card-title">
            {{ `Disciplina: ${disciplina.nombreDisciplina}` }}
          </h3>
          <!-- CONTENIDO -->
          <div class="my-3 px-3">
            <div class="table-horario mat-elevation-z8">
              <table mat-table [dataSource]="disciplina.horarios" class="mat-table-horario">
                <!-- Position Column -->
                <ng-container matColumnDef="id">
                  <th mat-header-cell *matHeaderCellDef>No.</th>
                  <td mat-cell *matCellDef="let row; let idx = index">{{ 1 + idx }}</td>
                </ng-container>

                <!-- Modalidad Column -->
                <ng-container matColumnDef="modalidad">
                  <th mat-header-cell *matHeaderCellDef>Modalidad</th>
                  <td mat-cell *matCellDef="let row">{{ row.modalidad.descripcion }}</td>
                </ng-container>

                <!-- Etapa Column -->
                <ng-container matColumnDef="etapa">
                  <th mat-header-cell *matHeaderCellDef>Etapa</th>
                  <td mat-cell *matCellDef="let row">{{ row.nivel.descripcion }}</td>
                </ng-container>
                <!-- Categoria Column -->
                <ng-container matColumnDef="categoria">
                  <th mat-header-cell *matHeaderCellDef>Categoria</th>
                  <td mat-cell *matCellDef="let row">{{`${row.categoriaedad.edadminima} a ${row.categoriaedad.edadmaxima} años`}}</td>
                </ng-container>
                <!-- Edad Column -->
                <ng-container matColumnDef="edad">
                  <th mat-header-cell *matHeaderCellDef>Edad</th>
                  <td mat-cell *matCellDef="let row">
                    {{
                      row.modalidad.idModalidad === 1 ? row.listadisciplina.disciplina.edadDeporte : row.listadisciplina.disciplina.edadParadeporte
                    }}
                  </td>
                </ng-container>
                <!-- Frecuencia Column -->
                <ng-container matColumnDef="frecuencia">
                  <th mat-header-cell *matHeaderCellDef>frecuencia</th>
                  <td mat-cell *matCellDef="let row">{{ mostrarDiasenhorarios(row.turno.listadia) }}</td>
                </ng-container>
                <!-- Hora Column -->
                <ng-container matColumnDef="hora">
                  <th mat-header-cell *matHeaderCellDef>Hora</th>
                  <td mat-cell *matCellDef="let row">{{`${row.turno.horainicio.slice(0, 5)} a ${row.turno.horafin.slice(0, 5)}`}}</td>
                </ng-container>
                <!-- Estado Column -->
                <ng-container matColumnDef="estado">
                  <th mat-header-cell *matHeaderCellDef>Estado</th>
                  <td mat-cell *matCellDef="let row">
                    <span>
                      {{ row.estado == "1" ? "EN CURSO" : "CERRADO" }}
                    </span>
                  </td>
                </ng-container>
                <!-- Vancantes Column -->
                <ng-container matColumnDef="vacante">
                  <th mat-header-cell *matHeaderCellDef>Vancantes</th>
                  <td mat-cell *matCellDef="let row">{{ row.numVacante }}</td>
                </ng-container>
                <!-- Inscrito Column -->
                <ng-container matColumnDef="inscrito">
                  <th mat-header-cell *matHeaderCellDef>Inscritos</th>
                  <td mat-cell *matCellDef="let row">{{ row.contador }}</td>
                </ng-container>
                <!-- Acción Column -->
                <ng-container matColumnDef="accion">
                  <th mat-header-cell *matHeaderCellDef>Acciones</th>
                  <td mat-cell *matCellDef="let row">
                    <button mat-icon-button color="primary" (click)="modalIrHorario(irHorario, disciplina, row.idHorario)">
                      <mat-icon>edit</mat-icon>
                    </button>
                    <button mat-icon-button color="warn" (click)="modalEliminar(eliminarHorario, row.idHorario, 'horario')">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="horarioColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: horarioColumns"></tr>
                <tr class="mat-row" *matNoDataRow>
                  <td class="mat-cell text-center" colspan="11">No existe horarios asignados</td>
                </tr>
              </table>
            </div>
          </div>
          <!-- ACCIONES -->
          <div align="end">
            <button mat-button color="primary" (click)="modalIrHorario(irHorario, disciplina, 0)"><mat-icon>add</mat-icon> Agregar horario</button>

            <button mat-button color="warn" (click)="modalEliminar(validarEliminar, disciplina.idDisciplina, 'disciplina')">
              <mat-icon>delete</mat-icon> Eliminar
            </button>
          </div>
        </div>
      </div>
      <div class="mt-4 p-0" align="end">
        <button matButton="outlined" (click)="prevTab($event, 'complejo')"><mat-icon>subdirectory_arrow_left</mat-icon>Ir a convocatorias</button>
      </div>
    </div>
  </mat-tab>

  <!-- HORARIO -->
  <!-- <mat-tab label="Horario" [disabled]="tabIndex !== 2">
 
  </mat-tab> -->
</mat-tab-group>

<ng-template #irHorario let-dialogData>
  <div class="title-modal" cdkFocusInitial>{{ idEditHorario == 0 ? "Agregando horarios" : "Actualizando Horario" }}</div>
  <div mat-dialog-content align="center">
    <p class="fs-6 fw-400 mb-4">HORARIO</p>
    <app-horarios-form [dialogData]="dialogData"></app-horarios-form>
  </div>
</ng-template>

<ng-template #validarEliminar>
  <div class="title-modal" cdkFocusInitial>¡Importante!</div>
  <div mat-dialog-content align="center">
    <p class="fs-6 fw-400 mb-4">¿Está seguro que desea eliminar esta disciplina?</p>
    <p>Tener en cuenta si elimina se eliminaran todos los horarios agregados</p>
  </div>
  <div mat-dialog-actions align="end" class="footerDialog d-flex">
    <button mat-flat-button color="primary" class="loadButton" type="button" (click)="deleteDisciplina()">SI</button>
    <button type="button" mat-raised-button color="secondary" class="loadButton btnCancelar" mat-dialog-close>Cancelar</button>
  </div>
</ng-template>
<ng-template #eliminarHorario>
  <div class="title-modal" cdkFocusInitial>¡Importante!</div>
  <div mat-dialog-content align="center">
    <p class="fs-6 fw-400 mb-4">¿Está seguro que desea eliminar este horario?</p>
    <p>Tener en cuenta si elimina este horario, la convocatoria también se eliminará</p>
  </div>
  <div mat-dialog-actions align="end" class="footerDialog d-flex">
    <button mat-flat-button color="primary" class="loadButton" type="button" (click)="deleteHorario()">SI</button>
    <button type="button" mat-raised-button color="secondary" class="loadButton btnCancelar" mat-dialog-close>Cancelar</button>
  </div>
</ng-template>
