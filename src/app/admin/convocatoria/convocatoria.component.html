<div class="convocatoria-container">
  
  <!-- Header -->
  <div class="header-section">
    <h1 class="titulo-principal">CONVOCATORIAS ABIERTAS</h1>
    <p class="subtitulo">Encuentra oportunidades para formar parte de nuestra comunidad deportiva</p>
  </div>

  <!-- ========================================== -->
  <!-- MODO USUARIO -->
  <!-- ========================================== -->
  <div *ngIf="!modoGestion">

    <!-- Filtros -->
    <div class="search-filter-section">
      <div class="search-row">
        <mat-form-field appearance="outline" class="search-field">
          <mat-label>Buscar convocatorias</mat-label>
          <input matInput [(ngModel)]="busquedaUsuario" (ngModelChange)="onFiltroChangeUsuario()" placeholder="Título, descripción...">
          <mat-icon matPrefix>search</mat-icon>
          <button mat-icon-button matSuffix *ngIf="busquedaUsuario" (click)="busquedaUsuario=''; onFiltroChangeUsuario()">
            <mat-icon>close</mat-icon>
          </button>
        </mat-form-field>

        <button mat-raised-button class="btn-limpiar" (click)="limpiarFiltrosUsuario()">
          <mat-icon>clear_all</mat-icon>
          <span class="btn-text">Limpiar Filtros</span>
        </button>
      </div>

      <!-- Filtros Interconectados -->
      <div class="filtros-grid">
        <mat-form-field appearance="outline">
          <mat-label>Región</mat-label>
          <mat-select [(ngModel)]="regionSeleccionadaUsuario" (ngModelChange)="onFiltroChangeUsuario()">
            <mat-option value="">Todas las regiones</mat-option>
            <mat-option *ngFor="let r of regionesDisponiblesUsuario" [value]="r">{{ r }}</mat-option>
          </mat-select>
          <mat-icon matPrefix>location_on</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Sede</mat-label>
          <mat-select [(ngModel)]="sedeSeleccionadaUsuario" (ngModelChange)="onFiltroChangeUsuario()">
            <mat-option value="">Todas las sedes</mat-option>
            <mat-option *ngFor="let s of sedesDisponiblesUsuario" [value]="s">{{ s }}</mat-option>
          </mat-select>
          <mat-icon matPrefix>stadium</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Deporte</mat-label>
          <mat-select [(ngModel)]="deporteSeleccionadoUsuario" (ngModelChange)="onDeporteChangeUsuario()">
            <mat-option value="">Todos los deportes</mat-option>
            <mat-option *ngFor="let d of deportesDisponiblesUsuario" [value]="d">{{ d }}</mat-option>
          </mat-select>
          <mat-icon matPrefix>sports_soccer</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Tipo Convocatoria</mat-label>
          <mat-select [(ngModel)]="filtroTipoUsuario" (ngModelChange)="onFiltroChangeUsuario()">
            <mat-option *ngFor="let t of tiposConvocatoria" [value]="t.value">{{ t.label }}</mat-option>
          </mat-select>
          <mat-icon matPrefix>category</mat-icon>
        </mat-form-field>
      </div>

      <div class="resultados-row">
        <div class="resultados-info">
          <strong>{{ totalConvocatoriasUsuario }}</strong> 
          {{ totalConvocatoriasUsuario === 1 ? 'convocatoria encontrada' : 'convocatorias encontradas' }}
        </div>
        <button mat-raised-button color="primary" class="btn-gestionar" (click)="toggleModoGestion()">
          <mat-icon>settings</mat-icon>
          <span class="btn-text">Gestionar</span>
        </button>
      </div>
    </div>

    <!-- Loader -->
    <div *ngIf="cargando" class="loader-container">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Cargando convocatorias...</p>
    </div>

    <!-- FLIP CARDS -->
    <div *ngIf="!cargando && totalConvocatoriasUsuario > 0" class="flip-cards-grid">
      <div *ngFor="let conv of convocatoriasPaginadasUsuario" 
           class="flip-card-container" 
           [class.is-flipped]="conv.isFlipped"
           (click)="toggleFlipCard(conv, $event)"
           [@fadeIn]>
        <div class="flip-card">
          
          <!-- FRENTE - Diseño original con imagen de fondo -->
          <div class="flip-card-front">
            <!-- Imagen de fondo -->
            <img [src]="conv.urlimagen" [alt]="conv.titulo" class="card-imagen">
            <div class="card-gradient"></div>
            
            <!-- Badges superiores -->
            <div class="card-badges">
              <span class="badge-tipo" [ngClass]="getTipoClass(conv.tipo)">{{ getTipoTexto(conv.tipo) }}</span>
              <span class="badge-estado" [ngClass]="getEstadoClass(conv.estado)">
                <mat-icon>{{ conv.estado === 'activa' ? 'check_circle' : 'cancel' }}</mat-icon>
                {{ getEstadoTexto(conv.estado) }}
              </span>
            </div>
            
            <!-- Contenido inferior -->
            <div class="card-front-content">
              <h3 class="card-titulo">{{ conv.titulo }}</h3>
              
              <!-- Barra de ocupación -->
              <div class="cupos-section">
                <div class="cupos-header">
                  <span class="cupos-label">Cupos disponibles</span>
                  <span class="cupos-numeros">
                    <span class="cupos-disponibles" [style.color]="getColorBarra(conv)">{{ conv.numdisponibles }}</span>
                    <span class="cupos-separator">/ {{ conv.numvacantes }}</span>
                  </span>
                </div>
                <div class="progress-bar-container">
                  <div class="progress-bar" 
                       [style.width.%]="100 - getPorcentajeOcupacion(conv)" 
                       [style.background]="getColorBarra(conv)">
                  </div>
                </div>
              </div>
              
              <!-- Ver más detalles -->
              <div class="ver-detalles">
                <mat-icon>touch_app</mat-icon>
                <span>Ver más detalles</span>
              </div>
            </div>
          </div>

          <!-- REVERSO - Según imagen 2 -->
          <div class="flip-card-back">
            <!-- Header del reverso -->
            <div class="back-header">
              <h3 class="back-titulo">{{ conv.titulo }}</h3>
              <span class="back-temporada">{{ conv.temporada}}</span>
            </div>

            <!-- Bloques de horarios -->
            <div class="back-horarios-container">
              <div class="horario-bloque" *ngFor="let h of conv.horarios">
                <div class="horario-linea">
                  <mat-icon>calendar_today</mat-icon>
                  <span class="horario-dias">{{ h.dias }}</span>
                </div>
                <div class="horario-linea">
                  <mat-icon>schedule</mat-icon>
                  <span class="horario-hora">{{ h.hora }}</span>
                </div>
                <div class="horario-linea">
                  <mat-icon>place</mat-icon>
                  <span class="horario-sede">{{ h.sede }}</span>
                </div>
              </div>
            </div>

            <!-- Botón inscribirse -->
            <button type="button" 
                    class="btn-inscribirse" 
                    (click)="inscribirse(conv, $event)">
              <mat-icon>person_add</mat-icon>
              <span>Inscribirse Ahora</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Sin resultados -->
    <div *ngIf="!cargando && totalConvocatoriasUsuario === 0" class="sin-resultados">
      <mat-icon>search_off</mat-icon>
      <h3>No se encontraron convocatorias</h3>
      <p>Intenta ajustar los filtros de búsqueda</p>
    </div>

    <!-- Paginación -->
    <mat-paginator *ngIf="totalConvocatoriasUsuario > pageSizeUsuario"
      [length]="totalConvocatoriasUsuario"
      [pageSize]="pageSizeUsuario"
      [pageSizeOptions]="pageSizeOptions"
      (page)="cambiarPaginaUsuario($event)"
      showFirstLastButtons>
    </mat-paginator>
  </div>

  <!-- ========================================== -->
  <!-- MODO GESTIÓN -->
  <!-- ========================================== -->
  <div *ngIf="modoGestion" class="gestion-container">
    <div class="gestion-header">
      <h2>Gestión de Convocatorias</h2>
      <div class="gestion-buttons">
        <button mat-raised-button color="accent" (click)="newConvocatoria()">
          <mat-icon>add_circle</mat-icon>
          Nueva
        </button>
        <button mat-stroked-button (click)="toggleModoGestion()">
          <mat-icon>arrow_back</mat-icon>
          Volver
        </button>
      </div>
    </div>

    <!-- Filtros Gestión Interconectados -->
    <div class="gestion-filtros">
      <div class="search-row">
        <mat-form-field appearance="outline" class="search-field">
          <mat-label>Buscar</mat-label>
          <input matInput [(ngModel)]="busquedaGestion" (ngModelChange)="onFiltroChangeGestion()" placeholder="Título, descripción...">
          <mat-icon matPrefix>search</mat-icon>
          <button mat-icon-button matSuffix *ngIf="busquedaGestion" (click)="busquedaGestion=''; onFiltroChangeGestion()">
            <mat-icon>close</mat-icon>
          </button>
        </mat-form-field>

        <button mat-raised-button class="btn-limpiar" (click)="limpiarFiltrosGestion()">
          <mat-icon>clear_all</mat-icon>
          <span class="btn-text">Limpiar</span>
        </button>
      </div>

      <div class="filtros-grid">
        <mat-form-field appearance="outline">
          <mat-label>Región</mat-label>
          <mat-select [(ngModel)]="regionSeleccionadaGestion" (ngModelChange)="onFiltroChangeGestion()">
            <mat-option value="">Todas</mat-option>
            <mat-option *ngFor="let r of regionesDisponiblesGestion" [value]="r">{{ r }}</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Sede</mat-label>
          <mat-select [(ngModel)]="sedeSeleccionadaGestion" (ngModelChange)="onFiltroChangeGestion()">
            <mat-option value="">Todas</mat-option>
            <mat-option *ngFor="let s of sedesDisponiblesGestion" [value]="s">{{ s }}</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Deporte</mat-label>
          <mat-select [(ngModel)]="deporteSeleccionadoGestion" (ngModelChange)="onFiltroChangeGestion()">
            <mat-option value="">Todos</mat-option>
            <mat-option *ngFor="let d of deportesDisponiblesGestion" [value]="d">{{ d }}</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Tipo</mat-label>
          <mat-select [(ngModel)]="filtroTipoGestion" (ngModelChange)="onFiltroChangeGestion()">
            <mat-option *ngFor="let t of tiposConvocatoria" [value]="t.value">{{ t.label }}</mat-option>
          </mat-select>
        </mat-form-field>
      </div>
    </div>

    <!-- Tabla -->
    <div class="tabla-wrapper">
      <table class="tabla-gestion">
        <thead>
          <tr>
            <th>#</th>
            <th>Título</th>
            <th>Subtítulo</th>
            <th class="hide-mobile">Descripción</th>
            <th>Horarios</th>
            <th>Disponibles</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let conv of convocatoriasPaginadasGestion; let i = index">
            <td>{{ (pageIndexGestion * pageSizeGestion) + i + 1 }}</td>
            <td><strong>{{ conv.titulo }}</strong></td>
            <td>{{ conv.subtitulo }}</td>
            <td class="descripcion-cell hide-mobile">{{ conv.descripcion }}</td>
            <td><span class="horarios-count">{{ conv.horarios.length }}</span></td>
            <td><strong>{{ conv.numdisponibles }}</strong>/{{ conv.numvacantes }}</td>
            <td><span class="tabla-estado" [ngClass]="getEstadoClass(conv.estado)">{{ getEstadoTexto(conv.estado) }}</span></td>
            <td>
              <div class="acciones-btns">
                <button mat-icon-button color="primary" (click)="editarConvocatoria(conv)" matTooltip="Editar"><mat-icon>edit</mat-icon></button>
                <button mat-icon-button color="accent" (click)="verPreview(conv)" matTooltip="Vista previa"><mat-icon>visibility</mat-icon></button>
                <button mat-icon-button color="warn" (click)="confirmarEliminar(conv)" matTooltip="Eliminar"><mat-icon>delete</mat-icon></button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <mat-paginator [length]="totalConvocatoriasGestion" [pageSize]="pageSizeGestion" [pageSizeOptions]="pageSizeOptions" (page)="cambiarPaginaGestion($event)" showFirstLastButtons></mat-paginator>
  </div>

  <!-- ========================================== -->
  <!-- MODAL DEPORTE -->
  <!-- ========================================== -->
  <div class="modal-deporte-overlay" *ngIf="mostrarModalDeporte">
    <div class="modal-deporte" [@modalFadeIn] (click)="$event.stopPropagation()">
      <button class="btn-cerrar-deporte" (click)="cerrarModalDeporte()"><mat-icon>close</mat-icon></button>
      <div class="deporte-content" *ngIf="deporteInfoActual">
        <div class="deporte-imagen">
          <img [src]="deporteInfoActual.imagen" [alt]="deporteInfoActual.nombre">
          <div class="deporte-nombre-overlay"><h2>{{ deporteInfoActual.nombre }}</h2></div>
        </div>
        <div class="deporte-info">
          <div class="info-header"><mat-icon>sports</mat-icon><span>Acerca del deporte</span></div>
          <p>{{ deporteInfoActual.descripcion }}</p>
          <div class="info-footer"><mat-icon>info</mat-icon><span>A continuación verás las convocatorias disponibles.</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ========================================== -->
  <!-- MODAL FORMULARIO -->
  <!-- ========================================== -->
  <div class="modal-form-overlay" *ngIf="mostrarFormulario">
    <div class="modal-form" (click)="$event.stopPropagation()">
      <div class="modal-form-header">
        <h2>{{ modoEdicion ? 'Editar Convocatoria' : 'Nueva Convocatoria' }}</h2>
        <button mat-icon-button (click)="cerrarFormulario()"><mat-icon>close</mat-icon></button>
      </div>

      <div class="modal-form-body">
        <div class="section-title">Información Básica</div>
        
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Título *</mat-label>
          <input matInput [(ngModel)]="nuevaConvocatoria.titulo" name="titulo">
          <mat-error *ngIf="erroresFormulario['titulo']">Obligatorio</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Subtítulo *</mat-label>
          <input matInput [(ngModel)]="nuevaConvocatoria.subtitulo" name="subtitulo">
          <mat-error *ngIf="erroresFormulario['subtitulo']">Obligatorio</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Descripción *</mat-label>
          <textarea matInput [(ngModel)]="nuevaConvocatoria.descripcion" name="descripcion" rows="3"></textarea>
          <mat-error *ngIf="erroresFormulario['descripcion']">Obligatorio</mat-error>
        </mat-form-field>

        <div class="section-title">Imagen</div>
        <div class="imagen-upload-section">
          <input type="file" #fileInput (change)="seleccionarImagen($event)" accept="image/*" hidden>
          <button mat-stroked-button type="button" (click)="fileInput.click()">
            <mat-icon>cloud_upload</mat-icon> Seleccionar
          </button>
          <span *ngIf="imagenSeleccionada" class="nombre-archivo">{{ imagenSeleccionada.name }}</span>
        </div>
        <img *ngIf="imagenPreview" [src]="imagenPreview" class="preview-imagen" alt="Preview">

        <div class="section-title">Horarios</div>
        <div class="horarios-container">
          <div class="horarios-input-row">
            <mat-form-field appearance="outline" class="horarios-field">
              <mat-label>Buscar horario</mat-label>
              <input type="text" matInput [(ngModel)]="horarioSeleccionadoTexto" (ngModelChange)="filtrarHorariosAutocomplete()" [matAutocomplete]="autoHorario" name="horarioSearch" placeholder="Escribe...">
              <mat-icon matPrefix>search</mat-icon>
              <mat-autocomplete #autoHorario="matAutocomplete" [displayWith]="displayHorario" (optionSelected)="onHorarioSelected($event)" class="horario-panel">
                <mat-option *ngFor="let h of horariosFiltradosAutocomplete" [value]="h">
                  <div class="autocomplete-option">
                    <mat-icon>schedule</mat-icon>
                    <div class="option-info"><strong>{{ h.dias }} - {{ h.hora }}</strong><small>{{ h.sede }}</small></div>
                  </div>
                </mat-option>
              </mat-autocomplete>
            </mat-form-field>
            <button mat-raised-button color="primary" type="button" class="btn-agregar-horario" [disabled]="!horarioTemporal" (click)="agregarHorario()">
              <mat-icon>add</mat-icon> Agregar
            </button>
          </div>

          <div class="horarios-agregados" *ngIf="horariosAgregados.length > 0">
            <h4>Horarios ({{ horariosAgregados.length }})</h4>
            <div class="horario-agregado" *ngFor="let h of horariosAgregados">
              <div class="horario-info">
                <mat-icon>schedule</mat-icon>
                <div class="horario-textos"><span class="horario-turno">{{ h.dias }} - {{ h.hora }}</span><span class="horario-detalles">{{ h.sede }}</span></div>
              </div>
              <button mat-icon-button color="warn" type="button" (click)="eliminarHorario(h)"><mat-icon>delete</mat-icon></button>
            </div>
          </div>

          <div class="sin-horarios" *ngIf="horariosAgregados.length === 0">
            <mat-icon>info</mat-icon><span>Agregue al menos un horario</span>
          </div>
        </div>

        <div class="section-title">Cupos</div>
        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Vacantes *</mat-label>
          <input matInput type="number" [(ngModel)]="nuevaConvocatoria.numvacantes" name="numvacantes" min="1">
          <mat-error *ngIf="erroresFormulario['numvacantes']">Mayor a 0</mat-error>
        </mat-form-field>
      </div>

      <div class="modal-form-footer">
        <button mat-raised-button (click)="cerrarFormulario()">Cancelar</button>
        <button mat-raised-button color="primary" (click)="guardarConvocatoria()">{{ modoEdicion ? 'Actualizar' : 'Guardar' }}</button>
      </div>
    </div>
  </div>

  <!-- ========================================== -->
  <!-- MODAL PREVIEW - DISEÑO FLIP CARD -->
  <!-- ========================================== -->
  <div class="modal-preview-overlay" *ngIf="mostrarPreview" (click)="cerrarPreview()">
    <div class="modal-preview" (click)="$event.stopPropagation()">
      <button class="btn-cerrar-preview" (click)="cerrarPreview()"><mat-icon>close</mat-icon></button>
      <h2 class="preview-title">Vista Previa</h2>

      <div class="preview-card-container" *ngIf="convocatoriaPreview">
        <div class="preview-front">
          <img [src]="convocatoriaPreview.urlimagen" [alt]="convocatoriaPreview.titulo" class="preview-img">
          <div class="preview-gradient"></div>
          <div class="preview-badges">
            <span class="preview-badge-tipo" [ngClass]="getTipoClass(convocatoriaPreview.tipo)">{{ getTipoTexto(convocatoriaPreview.tipo) }}</span>
            <span class="preview-badge-estado" [ngClass]="getEstadoClass(convocatoriaPreview.estado)">
              <mat-icon>{{ convocatoriaPreview.estado === 'activa' ? 'check_circle' : 'cancel' }}</mat-icon>
              {{ getEstadoTexto(convocatoriaPreview.estado) }}
            </span>
          </div>
          <div class="preview-front-info">
            <h3>{{ convocatoriaPreview.titulo }}</h3>
            <div class="preview-cupos">
              <span>Cupos disponibles</span>
              <strong [style.color]="getColorBarra(convocatoriaPreview)">{{ convocatoriaPreview.numdisponibles }}/{{ convocatoriaPreview.numvacantes }}</strong>
            </div>
            <div class="preview-progress">
              <div class="preview-bar" [style.width.%]="100 - getPorcentajeOcupacion(convocatoriaPreview)" [style.background]="getColorBarra(convocatoriaPreview)"></div>
            </div>
          </div>
        </div>

        <div class="preview-details">
          <h3>{{ convocatoriaPreview.titulo }}</h3>
          <span class="preview-temporada">{{ convocatoriaPreview.temporada || 'Temporada 2026' }}</span>
          <div class="preview-horarios">
            <div class="preview-horario" *ngFor="let h of convocatoriaPreview.horarios">
              <div class="ph-linea"><mat-icon>calendar_today</mat-icon><span>{{ h.dias }}</span></div>
              <div class="ph-linea"><mat-icon>schedule</mat-icon><span>{{ h.hora }}</span></div>
              <div class="ph-linea"><mat-icon>place</mat-icon><span>{{ h.sede }}</span></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ========================================== -->
  <!-- MODAL CONFIRMACIÓN -->
  <!-- ========================================== -->
  <div class="modal-confirm-overlay" *ngIf="mostrarConfirmacion">
    <div class="modal-confirm">
      <div class="confirm-header"><mat-icon>help_outline</mat-icon><h2>{{ tituloConfirmacion }}</h2></div>
      <div class="confirm-body"><p>{{ mensajeConfirmacion }}</p></div>
      <div class="confirm-footer">
        <button mat-raised-button (click)="cancelarConfirmacion()">Cancelar</button>
        <button mat-raised-button color="warn" (click)="confirmarAccion()">Confirmar</button>
      </div>
    </div>
  </div>

  <!-- ========================================== -->
  <!-- MENSAJE CENTRAL -->
  <!-- ========================================== -->
  <div class="mensaje-overlay" *ngIf="mostrarMensajeCentral">
    <div class="mensaje-box" [ngClass]="'mensaje-' + tipoMensaje">
      <mat-spinner *ngIf="tipoMensaje === 'loading'" diameter="40"></mat-spinner>
      <mat-icon *ngIf="tipoMensaje === 'success'">check_circle</mat-icon>
      <mat-icon *ngIf="tipoMensaje === 'error'">error</mat-icon>
      <p>{{ textoMensaje }}</p>
    </div>
  </div>

</div>