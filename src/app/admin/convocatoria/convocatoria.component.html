<div class="convocatoria-container">
  
  <!-- Header Compacto -->
  <div class="header-section">
    <h1 class="titulo-principal">CONVOCATORIAS ABIERTAS</h1>
    <p class="subtitulo">Encuentra oportunidades para formar parte de nuestra comunidad deportiva</p>
  </div>

  <!-- ========================================== -->
  <!-- MODO USUARIO: Vista de convocatorias -->
  <!-- ========================================== -->
  <div *ngIf="!modoGestion">

    <!-- Barra de búsqueda y filtros -->
    <div class="search-filter-section">
      
      <!-- Buscador principal -->
      <div class="search-container">
        <mat-form-field appearance="outline" class="search-field">
          <mat-label>Buscar convocatorias</mat-label>
          <input matInput 
                 [(ngModel)]="busqueda" 
                 (ngModelChange)="aplicarFiltros()"
                 placeholder="Título, organización, descripción...">
          <mat-icon matPrefix>search</mat-icon>
          <button mat-icon-button matSuffix *ngIf="busqueda" (click)="busqueda=''; aplicarFiltros()">
            <mat-icon>close</mat-icon>
          </button>
        </mat-form-field>

        <!-- Botón toggle filtros -->
        <button mat-raised-button 
                color="primary" 
                class="btn-filtros"
                (click)="toggleFiltros()">
          <mat-icon>filter_list</mat-icon>
          {{ mostrarFiltros ? 'Ocultar Filtros' : 'Mostrar Filtros' }}
        </button>
      </div>

      <!-- Panel de filtros -->
      <div class="filtros-panel" [class.expanded]="mostrarFiltros">
        <div class="filtros-grid">
          
          <!-- Filtro Región -->
          <mat-form-field appearance="outline">
            <mat-label>Región</mat-label>
            <mat-select [(ngModel)]="regionSeleccionada" (ngModelChange)="aplicarFiltros()">
              <mat-option value="">Todas las regiones</mat-option>
              <mat-option *ngFor="let region of regiones" [value]="region">
                {{ region }}
              </mat-option>
            </mat-select>
            <mat-icon matPrefix>location_on</mat-icon>
          </mat-form-field>

          <!-- Filtro Sede -->
          <mat-form-field appearance="outline">
            <mat-label>Sede</mat-label>
            <mat-select [(ngModel)]="sedeSeleccionada" (ngModelChange)="aplicarFiltros()">
              <mat-option value="">Todas las sedes</mat-option>
              <mat-option *ngFor="let sede of sedes" [value]="sede">
                {{ sede }}
              </mat-option>
            </mat-select>
            <mat-icon matPrefix>stadium</mat-icon>
          </mat-form-field>

          <!-- Filtro Estado -->
          <mat-form-field appearance="outline">
            <mat-label>Estado</mat-label>
            <mat-select [(ngModel)]="estadoSeleccionado" (ngModelChange)="aplicarFiltros()">
              <mat-option value="">Todos los estados</mat-option>
              <mat-option *ngFor="let estado of estadosOptions" [value]="estado.value">
                {{ estado.label }}
              </mat-option>
            </mat-select>
            <mat-icon matPrefix>info</mat-icon>
          </mat-form-field>

          <!-- Fecha inicio desde -->
          <mat-form-field appearance="outline">
            <mat-label>Fecha inicio desde</mat-label>
            <input matInput 
                   [matDatepicker]="pickerInicio" 
                   [(ngModel)]="fechaInicioFiltro"
                   (ngModelChange)="aplicarFiltros()"
                   placeholder="DD/MM/AAAA">
            <mat-datepicker-toggle matSuffix [for]="pickerInicio"></mat-datepicker-toggle>
            <mat-datepicker #pickerInicio></mat-datepicker>
          </mat-form-field>

          <!-- Fecha fin hasta -->
          <mat-form-field appearance="outline">
            <mat-label>Fecha fin hasta</mat-label>
            <input matInput 
                   [matDatepicker]="pickerFin" 
                   [(ngModel)]="fechaFinFiltro"
                   (ngModelChange)="aplicarFiltros()"
                   placeholder="DD/MM/AAAA">
            <mat-datepicker-toggle matSuffix [for]="pickerFin"></mat-datepicker-toggle>
            <mat-datepicker #pickerFin></mat-datepicker>
          </mat-form-field>

          <!-- Botón limpiar -->
          <button mat-raised-button 
                  class="btn-limpiar"
                  (click)="limpiarFiltros()">
            <mat-icon>clear_all</mat-icon>
            Limpiar Filtros
          </button>
        </div>
      </div>

      <!-- Resultados y Gestionar -->
      <div class="resultados-row">
        <div class="resultados-info">
          <strong>{{ totalConvocatorias }}</strong> 
          {{ totalConvocatorias === 1 ? 'convocatoria encontrada' : 'convocatorias encontradas' }}
        </div>
        <button mat-raised-button 
                color="primary"
                class="btn-gestionar"
                (click)="toggleModoGestion()">
          <mat-icon>settings</mat-icon>
          Gestionar Convocatorias
        </button>
      </div>
    </div>

    <!-- Loader -->
    <div *ngIf="cargando" class="loader-container">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Cargando convocatorias...</p>
    </div>

    <!-- Grid de Convocatorias (3 por fila) -->
    <div *ngIf="!cargando && totalConvocatorias > 0" class="convocatorias-grid">
      
      <mat-card *ngFor="let conv of convocatoriasPaginadas" class="convocatoria-card">
        
        <!-- Imagen -->
        <div class="card-image-container">
          <img mat-card-image 
               [src]="conv.urlimagen" 
               [alt]="conv.titulo"
               onerror="this.src='assets/images/placeholder-convocatoria.jpg'">
          
          <div class="estado-badge" [ngClass]="getEstadoClass(conv.estado)">
            {{ getEstadoTexto(conv.estado) }}
          </div>
        </div>

        <!-- Contenido -->
        <mat-card-content>
          <h3 class="card-title">{{ conv.titulo }}</h3>
          <p class="card-subtitulo">{{ conv.subtitulo }}</p>

          <div class="card-info">
            <div class="info-item">
              <mat-icon>event</mat-icon>
              <span>{{ formatearFecha(conv.fechainicioinscripcion) }} al {{ formatearFecha(conv.fechafininscripcion) }}</span>
            </div>

            <div class="info-item">
              <mat-icon>calendar_today</mat-icon>
              <span>{{ formatearFecha(conv.fechainicioactividad) }} al {{ formatearFecha(conv.fechafinactividad) }}</span>
            </div>
          </div>

          <!-- Cupos -->
          <div class="cupos-container">
            <div class="cupos-info">
              <strong>Disponibles: {{ conv.numdisponibles }}</strong>
              <span class="cupos-detalle">Vacantes: {{ conv.numvacantes }} | Inscritos: {{ conv.numinscritos }}</span>
            </div>
            
            <div class="progress-bar">
              <div class="progress-fill" 
                   [style.width.%]="getPorcentajeCupos(conv)"
                   [ngClass]="{
                     'progress-low': getPorcentajeCupos(conv) < 50,
                     'progress-medium': getPorcentajeCupos(conv) >= 50 && getPorcentajeCupos(conv) < 80,
                     'progress-high': getPorcentajeCupos(conv) >= 80
                   }">
              </div>
            </div>
          </div>
        </mat-card-content>

        <!-- Acciones -->
        <mat-card-actions class="card-actions">
          <button mat-raised-button 
                  color="accent" 
                  class="btn-inscribirse"
                  [disabled]="conv.estado !== 'activa' || conv.numdisponibles === 0"
                  (click)="inscribirse(conv)">
            <mat-icon>how_to_reg</mat-icon>
            {{ conv.estado === 'activa' ? 'Inscribirme' : 'No disponible' }}
          </button>

          <button mat-stroked-button 
                  class="btn-compartir"
                  (click)="compartir(conv)">
            <mat-icon>share</mat-icon>
            Compartir
          </button>
        </mat-card-actions>
      </mat-card>
    </div>

    <!-- Paginador -->
    <div *ngIf="!cargando && totalConvocatorias > 0" class="paginador-container">
      <mat-paginator 
        [length]="totalConvocatorias"
        [pageSize]="pageSize"
        [pageSizeOptions]="pageSizeOptions"
        [pageIndex]="pageIndex"
        (page)="onPageChange($event)"
        showFirstLastButtons>
      </mat-paginator>
    </div>

    <!-- Sin resultados -->
    <div *ngIf="!cargando && totalConvocatorias === 0" class="no-results">
      <mat-icon>search_off</mat-icon>
      <h3>No se encontraron convocatorias</h3>
      <p>Intenta ajustar los filtros de búsqueda</p>
      <button mat-raised-button color="primary" (click)="limpiarFiltros()">
        Limpiar filtros
      </button>
    </div>

  </div>

  <!-- ========================================== -->
  <!-- MODO GESTIÓN -->
  <!-- ========================================== -->
  <div *ngIf="modoGestion" class="gestion-container">

    <div class="gestion-header">
      <h2>Gestión de Convocatorias</h2>
      <div class="gestion-buttons">
        <button mat-raised-button 
                color="accent"
                (click)="toggleModoGestion()">
          <mat-icon>visibility</mat-icon>
          Ver Convocatorias
        </button>
        <button mat-raised-button 
                color="primary"
                (click)="abrirFormularioNueva()">
          <mat-icon>add</mat-icon>
          Nueva Convocatoria
        </button>
      </div>
    </div>

    <div class="tabla-gestion">
      <table mat-table [dataSource]="convocatorias" class="mat-elevation-z2">

        <ng-container matColumnDef="numero">
          <th mat-header-cell *matHeaderCellDef>N°</th>
          <td mat-cell *matCellDef="let conv; let i = index">{{ i + 1 }}</td>
        </ng-container>

        <ng-container matColumnDef="titulo">
          <th mat-header-cell *matHeaderCellDef>Título</th>
          <td mat-cell *matCellDef="let conv">{{ conv.titulo }}</td>
        </ng-container>

        <ng-container matColumnDef="subtitulo">
          <th mat-header-cell *matHeaderCellDef>Subtítulo</th>
          <td mat-cell *matCellDef="let conv">{{ conv.subtitulo }}</td>
        </ng-container>

        <ng-container matColumnDef="region">
          <th mat-header-cell *matHeaderCellDef>Región</th>
          <td mat-cell *matCellDef="let conv">{{ conv.region }}</td>
        </ng-container>

        <ng-container matColumnDef="sede">
          <th mat-header-cell *matHeaderCellDef>Sede</th>
          <td mat-cell *matCellDef="let conv">{{ conv.sede }}</td>
        </ng-container>

        <ng-container matColumnDef="fechainicioinscripcion">
          <th mat-header-cell *matHeaderCellDef>Inicio Inscripción</th>
          <td mat-cell *matCellDef="let conv">{{ formatearFecha(conv.fechainicioinscripcion) }}</td>
        </ng-container>

        <ng-container matColumnDef="fechafininscripcion">
          <th mat-header-cell *matHeaderCellDef>Fin Inscripción</th>
          <td mat-cell *matCellDef="let conv">{{ formatearFecha(conv.fechafininscripcion) }}</td>
        </ng-container>

        <ng-container matColumnDef="numdisponibles">
          <th mat-header-cell *matHeaderCellDef>Disponibles</th>
          <td mat-cell *matCellDef="let conv">{{ conv.numdisponibles }}/{{ conv.numvacantes }}</td>
        </ng-container>

        <ng-container matColumnDef="estado">
          <th mat-header-cell *matHeaderCellDef>Estado</th>
          <td mat-cell *matCellDef="let conv">
            <span class="badge-estado" [ngClass]="getEstadoClass(conv.estado)">
              {{ getEstadoTexto(conv.estado) }}
            </span>
          </td>
        </ng-container>

        <ng-container matColumnDef="acciones">
          <th mat-header-cell *matHeaderCellDef>Acciones</th>
          <td mat-cell *matCellDef="let conv">
            <button mat-icon-button matTooltip="Ver preview" (click)="verPreview(conv)">
              <mat-icon>visibility</mat-icon>
            </button>
            <button mat-icon-button color="primary" matTooltip="Editar" (click)="editarConvocatoria(conv)">
              <mat-icon>edit</mat-icon>
            </button>
            <button mat-icon-button color="warn" matTooltip="Eliminar" (click)="eliminarConvocatoria(conv)">
              <mat-icon>delete</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="columnasTabla"></tr>
        <tr mat-row *matRowDef="let row; columns: columnasTabla;"></tr>
      </table>
    </div>
  </div>

  <!-- ========================================== -->
  <!-- MODAL FORMULARIO (SIN REGIÓN Y SEDE) -->
  <!-- ========================================== -->
  <div class="modal-overlay-fullscreen" *ngIf="mostrarFormulario" (click)="cerrarFormulario()">
    <div class="modal-formulario" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ modoEdicion ? 'Editar Convocatoria' : 'Nueva Convocatoria' }}</h2>
        <button mat-icon-button (click)="cerrarFormulario()">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="modal-body">
        <form class="formulario-convocatoria">

          <!-- Título -->
          <mat-form-field appearance="outline" class="field-full">
            <mat-label>Título *</mat-label>
            <input matInput [(ngModel)]="nuevaConvocatoria.titulo" name="titulo" required>
            <mat-error *ngIf="erroresFormulario['titulo']">El título es obligatorio</mat-error>
          </mat-form-field>

          <!-- Subtítulo -->
          <mat-form-field appearance="outline" class="field-full">
            <mat-label>Subtítulo *</mat-label>
            <input matInput [(ngModel)]="nuevaConvocatoria.subtitulo" name="subtitulo" required>
            <mat-error *ngIf="erroresFormulario['subtitulo']">El subtítulo es obligatorio</mat-error>
          </mat-form-field>

          <!-- Descripción -->
          <mat-form-field appearance="outline" class="field-full">
            <mat-label>Descripción *</mat-label>
            <textarea matInput [(ngModel)]="nuevaConvocatoria.descripcion" name="descripcion" rows="3" required></textarea>
            <mat-error *ngIf="erroresFormulario['descripcion']">La descripción es obligatoria</mat-error>
          </mat-form-field>

          <!-- Imagen -->
          <div class="upload-container">
            <label class="upload-label">Imagen (URL)</label>
            <input type="file" id="fileUpload" accept="image/*" (change)="onImagenSeleccionada($event)" hidden #fileInput>
            <button mat-raised-button type="button" (click)="fileInput.click()">
              <mat-icon>cloud_upload</mat-icon>
              Seleccionar Imagen
            </button>
            <div class="imagen-preview" *ngIf="imagenPreview">
              <img [src]="imagenPreview" alt="Preview">
            </div>
          </div>

          <!-- Fechas de Inscripción -->
          <div class="seccion-titulo">Fechas de Inscripción</div>
          <div class="form-row">
            <mat-form-field appearance="outline" class="field-half">
              <mat-label>Inicio Inscripción *</mat-label>
              <input matInput 
                     [matDatepicker]="pickerInicioInsc"
                     [(ngModel)]="nuevaConvocatoria.fechainicioinscripcion"
                     name="fechainicioinscripcion"
                     placeholder="DD/MM/AAAA"
                     required>
              <mat-datepicker-toggle matSuffix [for]="pickerInicioInsc"></mat-datepicker-toggle>
              <mat-datepicker #pickerInicioInsc></mat-datepicker>
              <mat-error *ngIf="erroresFormulario['fechainicioinscripcion']">Obligatorio</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="field-half">
              <mat-label>Fin Inscripción *</mat-label>
              <input matInput 
                     [matDatepicker]="pickerFinInsc"
                     [(ngModel)]="nuevaConvocatoria.fechafininscripcion"
                     name="fechafininscripcion"
                     placeholder="DD/MM/AAAA"
                     required>
              <mat-datepicker-toggle matSuffix [for]="pickerFinInsc"></mat-datepicker-toggle>
              <mat-datepicker #pickerFinInsc></mat-datepicker>
              <mat-error *ngIf="erroresFormulario['fechafininscripcion']">Obligatorio</mat-error>
            </mat-form-field>
          </div>

          <!-- Fechas de Actividad -->
          <div class="seccion-titulo">Fechas de Actividad (Clases)</div>
          <div class="form-row">
            <mat-form-field appearance="outline" class="field-half">
              <mat-label>Inicio Actividad *</mat-label>
              <input matInput 
                     [matDatepicker]="pickerInicioAct"
                     [(ngModel)]="nuevaConvocatoria.fechainicioactividad"
                     name="fechainicioactividad"
                     placeholder="DD/MM/AAAA"
                     required>
              <mat-datepicker-toggle matSuffix [for]="pickerInicioAct"></mat-datepicker-toggle>
              <mat-datepicker #pickerInicioAct></mat-datepicker>
              <mat-error *ngIf="erroresFormulario['fechainicioactividad']">Obligatorio</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="field-half">
              <mat-label>Fin Actividad *</mat-label>
              <input matInput 
                     [matDatepicker]="pickerFinAct"
                     [(ngModel)]="nuevaConvocatoria.fechafinactividad"
                     name="fechafinactividad"
                     placeholder="DD/MM/AAAA"
                     required>
              <mat-datepicker-toggle matSuffix [for]="pickerFinAct"></mat-datepicker-toggle>
              <mat-datepicker #pickerFinAct></mat-datepicker>
              <mat-error *ngIf="erroresFormulario['fechafinactividad']">Obligatorio</mat-error>
            </mat-form-field>
          </div>

          <!-- Cupos -->
          <div class="seccion-titulo">Cupos</div>
          <div class="form-row">
            <mat-form-field appearance="outline" class="field-third">
              <mat-label>Vacantes *</mat-label>
              <input matInput type="number" [(ngModel)]="nuevaConvocatoria.numvacantes" name="numvacantes" min="1" required>
              <mat-error *ngIf="erroresFormulario['numvacantes']">Debe ser mayor a 0</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="field-third">
              <mat-label>Disponibles *</mat-label>
              <input matInput type="number" [(ngModel)]="nuevaConvocatoria.numdisponibles" name="numdisponibles" min="0" required>
              <mat-error *ngIf="erroresFormulario['numdisponibles']">No puede ser negativo</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="field-third">
              <mat-label>Inscritos *</mat-label>
              <input matInput type="number" [(ngModel)]="nuevaConvocatoria.numinscritos" name="numinscritos" min="0" required>
              <mat-error *ngIf="erroresFormulario['numinscritos']">No puede ser negativo</mat-error>
            </mat-form-field>
          </div>

          <!-- Estado -->
          <mat-form-field appearance="outline" class="field-full">
            <mat-label>Estado *</mat-label>
            <mat-select [(ngModel)]="nuevaConvocatoria.estado" name="estado" required>
              <mat-option *ngFor="let estado of estadosOptions" [value]="estado.value">
                {{ estado.label }}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="erroresFormulario['estado']">El estado es obligatorio</mat-error>
          </mat-form-field>

        </form>
      </div>

      <div class="modal-footer">
        <button mat-raised-button (click)="cerrarFormulario()">Cancelar</button>
        <button mat-raised-button color="primary" (click)="guardarConvocatoria()">
          {{ modoEdicion ? 'Actualizar' : 'Guardar' }}
        </button>
      </div>
    </div>
  </div>

  <!-- ========================================== -->
  <!-- MODAL PREVIEW -->
  <!-- ========================================== -->
  <div class="modal-overlay-fullscreen" *ngIf="mostrarPreview" (click)="cerrarPreview()">
    <div class="modal-preview" (click)="$event.stopPropagation()">
      <button class="btn-cerrar-preview" (click)="cerrarPreview()">
        <mat-icon>close</mat-icon>
      </button>

      <h2 class="preview-titulo">Vista Previa</h2>

      <mat-card class="convocatoria-card" *ngIf="convocatoriaPreview">
        <div class="card-image-container">
          <img mat-card-image [src]="convocatoriaPreview.urlimagen" [alt]="convocatoriaPreview.titulo">
          <div class="estado-badge" [ngClass]="getEstadoClass(convocatoriaPreview.estado)">
            {{ getEstadoTexto(convocatoriaPreview.estado) }}
          </div>
        </div>

        <mat-card-content>
          <h3 class="card-title">{{ convocatoriaPreview.titulo }}</h3>
          <p class="card-subtitulo">{{ convocatoriaPreview.subtitulo }}</p>

          <div class="card-info">
            <div class="info-item">
              <mat-icon>event</mat-icon>
              <span><strong>Inscripción:</strong> Del {{ formatearFecha(convocatoriaPreview.fechainicioinscripcion) }} al {{ formatearFecha(convocatoriaPreview.fechafininscripcion) }}</span>
            </div>

            <div class="info-item">
              <mat-icon>calendar_today</mat-icon>
              <span><strong>Clases:</strong> Del {{ formatearFecha(convocatoriaPreview.fechainicioactividad) }} al {{ formatearFecha(convocatoriaPreview.fechafinactividad) }}</span>
            </div>
          </div>

          <div class="cupos-container">
            <div class="cupos-info">
              <strong>Disponibles: {{ convocatoriaPreview.numdisponibles }}</strong>
              <span class="cupos-detalle">Vacantes: {{ convocatoriaPreview.numvacantes }} | Inscritos: {{ convocatoriaPreview.numinscritos }}</span>
            </div>
            
            <div class="progress-bar">
              <div class="progress-fill" 
                   [style.width.%]="getPorcentajeCupos(convocatoriaPreview)"
                   [ngClass]="{
                     'progress-low': getPorcentajeCupos(convocatoriaPreview) < 50,
                     'progress-medium': getPorcentajeCupos(convocatoriaPreview) >= 50 && getPorcentajeCupos(convocatoriaPreview) < 80,
                     'progress-high': getPorcentajeCupos(convocatoriaPreview) >= 80
                   }">
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <!-- ========================================== -->
  <!-- MODAL CONFIRMACIÓN PERSONALIZADO -->
  <!-- ========================================== -->
  <div class="modal-overlay-fullscreen" *ngIf="mostrarConfirmacion">
    <div class="modal-confirmacion">
      <div class="confirmacion-header">
        <mat-icon class="icono-confirmacion">help_outline</mat-icon>
        <h2>{{ tituloConfirmacion }}</h2>
      </div>
      
      <div class="confirmacion-body">
        <p>{{ mensajeConfirmacion }}</p>
      </div>
      
      <div class="confirmacion-footer">
        <button mat-raised-button (click)="cancelarConfirmacion()">
          Cancelar
        </button>
        <button mat-raised-button color="warn" (click)="confirmarAccion()">
          Confirmar
        </button>
      </div>
    </div>
  </div>

  <!-- ========================================== -->
  <!-- MENSAJE CENTRAL (Success/Error/Loading) -->
  <!-- ========================================== -->
  <div class="mensaje-central-overlay" *ngIf="mostrarMensajeCentral">
    <div class="mensaje-central" [ngClass]="'mensaje-' + tipoMensaje">
      <mat-spinner *ngIf="tipoMensaje === 'loading'" diameter="40" class="spinner-central"></mat-spinner>
      <mat-icon *ngIf="tipoMensaje === 'success'" class="icono-central">check_circle</mat-icon>
      <mat-icon *ngIf="tipoMensaje === 'error'" class="icono-central">error</mat-icon>
      <p class="texto-central">{{ textoMensaje }}</p>
    </div>
  </div>

</div>